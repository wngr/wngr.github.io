<!DOCTYPE HTML>
<html lang="en" class="coal sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>2021-03-24 Painless Cross-Compilation of Rust Crates - wngr</title>


        <!-- Custom HTML head -->

        <meta name="description" content="My personal notes. Mostly about programming.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "coal";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('coal')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">wngr</h1>

                    <div class="right-buttons">
                        <a href="https://github.com/wngr/wngr.github.io/tree/main/src" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="painless-rust-cross-compilation"><a class="header" href="#painless-rust-cross-compilation">Painless Rust Cross-Compilation</a></h1>
<h3 id="rusts-cross"><a class="header" href="#rusts-cross">Rust's <code>cross</code></a></h3>
<p>Rust is big on developer productivity: The tooling provided to get started with Rust development <em>just works</em>, be it
<code>cargo</code>, <code>rustup</code>, or <code>clippy</code>. Another tool is in the toolbox is <a href="https://github.com/rust-embedded/cross">cross</a>, which
lets you "magically" run tests or compile for other <a href="https://rust-lang.github.io/rustup-components-history/">build
targets</a>. Under the hood, cross provides a set of docker
containers (one for each supported target) containing a properly set up cross compilation toolchain and execution
environment; for example for
<a href="https://github.com/rust-embedded/cross/blob/master/docker/Dockerfile.arm-unknown-linux-gnueabihf"><code>arm-unknown-linux-gnueabihf</code></a>,
this includes the <code>arm-linux-gnueabihf-gcc</code> toolchain and <code>qemu-arm</code> for executing arm binaries.</p>
<p>Obviously, it would be a pain to set up each of those toolchains correctly on your host, and very hard to ensure build
reproducibility when collaborating.</p>
<h3 id="docker-buildx"><a class="header" href="#docker-buildx"><code>docker buildx</code></a></h3>
<p>In another ecosystem, <code>docker</code> is pushing its refactoring of the <code>docker build</code> subsystem
<a href="https://github.com/moby/buildkit"><code>moby/buildkit</code></a> slowly to become the standard of recent <code>docker</code> versions. One of
the notable additions is the additional of the <code>--platform</code> arg to <code>docker buildx</code>. Images can be created for multiple
architectures like so<sup class="footnote-reference"><a href="#0">1</a></sup>:</p>
<pre><code class="language-shell">docker buildx --platform linux/amd64,linux/aarch64,windows/amd64 .
</code></pre>
<p>This generates a so-called <a href="https://www.docker.com/blog/multi-arch-build-and-images-the-simple-way/">multi-arch image</a>,
where the image's manifest contains references to multiple images depending on the chosen architecture. Within the
<code>Dockerfile</code>, the following arguments are exposed: <code>BUILDPLATFORM</code> and <code>TARGETPLATFORM</code>.</p>
<h3 id="bringing-it-together"><a class="header" href="#bringing-it-together">Bringing it together</a></h3>
<p>Given a Cargo project, I'd like to cross-compile to multiple targets with a single call to <code>docker buildx</code>:</p>
<pre><code class="language-shell">docker buildx build --platform linux/amd64,linux/aarch64,windows/amd64 -o dist .
</code></pre>
<p>And this should yield:</p>
<pre><code class="language-shell">~ tree dist
dist
├── linux_amd64
│   ├── my_awesome_binary
├── linux_arm64
│   ├── my_awesome_binary
└── windows_amd64
    └── my_awesome_binary.exe
</code></pre>
<p>.. and here's the <code>Dockerfile</code> for this, with inlined comments:</p>
<pre><code class="language-Dockerfile"># Usage from crate root:
#   docker buildx build \
#     --platform linux/amd64,linux/aarch64 \
#     -f Dockerfile \
#     -o dist .
# This will put the resulting artefacts inside `./dist`.
ARG CROSSVER=0.2.1

# Poor man's mapping from buildx arch scheme to cargo
FROM --platform=$BUILDPLATFORM rustembedded/cross:aarch64-unknown-linux-musl-${CROSSVER} AS build-linux-arm64
ENV CARGO_BUILD_TARGET=aarch64-unknown-linux-musl
FROM --platform=$BUILDPLATFORM rustembedded/cross:x86_64-unknown-linux-musl-${CROSSVER} AS build-linux-amd64
ENV CARGO_BUILD_TARGET=x86_64-unknown-linux-musl
FROM --platform=$BUILDPLATFORM rustembedded/cross:arm-unknown-linux-musleabi-${CROSSVER} AS build-linux-armv6
ENV CARGO_BUILD_TARGET=arm-unknown-linux-musleabi
FROM --platform=$BUILDPLATFORM rustembedded/cross:armv7-unknown-linux-musleabihf-${CROSSVER} AS build-linux-armv7
ENV CARGO_BUILD_TARGET=armv7-unknown-linux-musleabihf
FROM --platform=$BUILDPLATFORM rustembedded/cross:x86_64-pc-windows-gnu-${CROSSVER} AS build-windows-amd64
ENV CARGO_BUILD_TARGET=x86_64-pc-windows-gnu

# actual build image
FROM --platform=$BUILDPLATFORM build-${TARGETOS}-${TARGETARCH}${TARGETVARIANT} AS crossbuild
ENV     CARGO_HOME=/usr/local/cargo \
        PATH=/usr/local/cargo/bin:$PATH
ARG RUSTVER=1.51.0

RUN curl https://sh.rustup.rs -sSf | sh -s -- \
    --default-toolchain ${RUSTVER} \
    --profile minimal \
    --target ${CARGO_BUILD_TARGET} \
    -y 

# actual building
FROM --platform=$BUILDPLATFORM crossbuild AS build
ENV CARGO_BUILD_JOBS=8
ARG TARGETPLATFORM
ARG BUILDPLATFORM
RUN echo "Building on $BUILDPLATFORM for $TARGETPLATFORM"
ARG TARGET_BINARY

WORKDIR /src
COPY . .

RUN cargo build --release

# move created binary to a well known place, as there is no access to the
# CARGO_BUILD_TARGET env var in the later extraction stage
# .. would be great to have `cargo build --out-dir` already on stable ..
RUN mkdir /out &amp;&amp; \
    mv /src/target/$CARGO_BUILD_TARGET/release/* /out

# create an empty image just with the built binary to export
FROM scratch

COPY --from=build /out/* .
</code></pre>
<p>Compared to other approaches, where one would use a shared cache for Cargo's intermediate artefacts (or sccache), I
found this approach to be surprisingly well suited for CI setups, as building the image is parallelized and heavily
cached by the Docker daemon, and quite maintainable, as there's only one build definition involved for all build
targets.</p>
<hr />
<div class="footnote-definition" id="0"><sup class="footnote-definition-label">1</sup>
<p>Yes, you read that right, even for Windows.</p>
</div>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../blog/2021-04-06_Sniffing-into-Signal-Backups.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../blog/2021-03-20_Dont-Panic.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../blog/2021-04-06_Sniffing-into-Signal-Backups.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../blog/2021-03-20_Dont-Panic.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>

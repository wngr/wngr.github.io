<!DOCTYPE HTML>
<html lang="en" class="coal" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>2021-08-31 Introduction to WebAssembly Threads in Rust - wngr</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="My personal notes. Mostly about programming.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "coal";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('coal')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="spacer"></li><li class="chapter-item expanded "><a href="../about.html"><strong aria-hidden="true">1.</strong> About</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.</strong> Blog</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../blog/2021-08-31_Introduction-Wasm-Threads.html" class="active"><strong aria-hidden="true">2.1.</strong> 2021-08-31 Introduction to WebAssembly Threads in Rust</a></li><li class="chapter-item expanded "><a href="../blog/2021-04-06_Sniffing-into-Signal-Backups.html"><strong aria-hidden="true">2.2.</strong> 2021-04-06 Sniffing into Signal Backups</a></li><li class="chapter-item expanded "><a href="../blog/2021-03-24_Rust-Cross.html"><strong aria-hidden="true">2.3.</strong> 2021-03-24 Painless Cross-Compilation of Rust Crates</a></li><li class="chapter-item expanded "><a href="../blog/2021-03-20_Dont-Panic.html"><strong aria-hidden="true">2.4.</strong> 2021-03-20 Don't panic!()</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">wngr</h1>

                    <div class="right-buttons">
                        <a href="https://github.com/wngr/wngr.github.io/tree/main/src" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="basic-introduction-to-webassembly-threads-in-rust"><a class="header" href="#basic-introduction-to-webassembly-threads-in-rust">Basic Introduction to WebAssembly Threads in Rust</a></h1>
<p>Quite some introductions have been written how to get started compiling Rust to
WebAssembly and using it in the browser. The inertia behind wasm threads however
fell prey to the Spectre/Meltdown mitigation measures introduced in early
2018<sup class="footnote-reference"><a href="#2">1</a></sup>. Fortunately, in the last 1.5 years the bits and pieces that make up
wasm threads were re-added to both Firefox and Chromium.</p>
<p>Wasm threads are not a atomic thing like POSIX threads, but rather are made up
of composable pieces. The main idea is simple really: Spawn wasm code into
mulitple web workers, and give them a shared slice of memory -- what could
possibly go wrong? Anyway, in order to synchronize access to the
<code>SharedArrayBuffer</code><sup class="footnote-reference"><a href="#3">2</a></sup>, a set of atomic instructions<sup class="footnote-reference"><a href="#4">3</a></sup> was introduced.
Those features are available for &quot;cross origin isolated&quot; websites, meaning that
a set of custom headers must be provided while serving the top level document,
and cross origin inclusions are restricted<sup class="footnote-reference"><a href="#5">4</a></sup>.</p>
<p>Let's take it step-by-step, from a wasm module loaded into the main js context,
over a wasm module loaded in a web worker, to a wasm module loaded in multiple
web workers and them communicating via shared memory.</p>
<p>Loading a wasm module on the browser's main thread is quite simple<sup class="footnote-reference"><a href="#6">5</a></sup> with the
right incantations of <code>wasm-bindgen</code>:</p>
<pre><code class="language-rust ignore noplayground ignore">use wasm_bindgen::prelude::*;

#[wasm_bindgen]
extern &quot;C&quot; {
    fn alert(s: &amp;str);
}

#[wasm_bindgen]
pub fn greet(name: &amp;str) {
    alert(&amp;format!(&quot;Hello, {}!&quot;, name));
}</code></pre>
<p>and is loaded inside <code>index.html</code> as a ES module:</p>
<pre><code class="language-html">&lt;html&gt;
  &lt;head&gt;
    &lt;meta content=&quot;text/html;charset=utf-8&quot; http-equiv=&quot;Content-Type&quot;/&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;script type=&quot;module&quot;&gt;
      import init, { greet } from './pkg/wasm_hello_world.js';

      async function run() {
        await init();

        greet(&quot;World&quot;);
      }
      run();
    &lt;/script&gt;
  &lt;/body&gt;
&lt;html&gt;
</code></pre>
<p>Spawning the wasm module inside a web worker does not require any changes to the
wasm module itself, just some glue code to spin up the <code>worker.js</code><sup class="footnote-reference"><a href="#7">6</a></sup>:</p>
<pre><code class="language-js">import init, { greet } from './pkg/wasm_hello_world.js';

self.onmessage = async event =&gt; {
  await init();
  greet(event.data);
}
</code></pre>
<p>and the <code>index.html</code> is adapted to:</p>
<pre><code class="language-html">    &lt;script type = &quot;module&quot;&gt;
      let worker = new Worker(&quot;./worker.js&quot;, { type: &quot;module&quot; });
      worker.postMessage(&quot;World!&quot;);
    &lt;/script&gt;
</code></pre>
<p>Now that we put that behind us, it get's more interesting with multiple
workers<sup class="footnote-reference"><a href="#8">7</a></sup>. The basic workflow is:</p>
<ol>
<li>Spawn workers.</li>
<li>Initialize wasm module with a shared memory slice (<code>SharedArrayBuffer</code>)
inside each worker.</li>
<li>Run your application.</li>
</ol>
<p>The wasm module gets a custom setup routine, where the workers are spawned, so
we don't have to write javascript (:shudder:).</p>
<pre><code class="language-rust ignore noplayground ignore">#[wasm_bindgen]
pub fn setup(n: usize) -&gt; Promise {
    console_error_panic_hook::set_once();

    let mut opts = WorkerOptions::new();
    opts.type_(WorkerType::Module);
    for i in 0..n {
        log(&amp;*format!(&quot;Starting worker {}&quot;, i));
        opts.name(&amp;*i.to_string());
        let worker = Worker::new_with_options(&quot;./worker.js&quot;, &amp;opts).unwrap();
        let arr = js_sys::Array::new();
        arr.push(&amp;wasm_bindgen::module());
        arr.push(&amp;wasm_bindgen::memory());

        worker.post_message(&amp;arr).unwrap();
    }
}</code></pre>
<p>The web worker is created, and a js array with the &quot;wasm module&quot; and the shared
memory slice is sent to it. There are only a handful of objects that are passed
through from the browser via the <code>postMessage</code> interface incl. those two. The
invoked <code>worker.js</code> code in the web worker looks like:</p>
<pre><code class="language-js">// First message is init
self.onmessage = async event =&gt; {
  let [module, memory] = event.data;

  let { default: init, entry } = await import('./pkg/wasm_hello_world.js')
  await init(module, memory);
  entry();

  // We don't expect any further messages
  self.onmessage = () =&gt; {
    throw new Error(&quot;Unexpected&quot;);
  }
}
</code></pre>
<p>The worker is initializing the wasm module with the call to the modules' default
export, and then invoking the <code>entry</code> founction, which again is defined in the
Rust code:</p>
<pre><code class="language-rust ignore">#[wasm_bindgen]
pub fn entry() {
    let name = js_sys::global()
        .unchecked_into::&lt;DedicatedWorkerGlobalScope&gt;()
        .name();
    log!(&quot;Hello from Worker {}&quot;, name);
}</code></pre>
<p>And that code is run within each worker's thread -- mission accomplished! You
can find the full code incl. build steps of the three examples above in the
linked repository.</p>
<p>So this is pretty basic, but it gets fairly complicated when trying to integrate
that approach into larger js application; let alone trying to bundle it together
with Webpack etc. In my next post, I'm going to introduce a library hiding all
the dirty details behind a (hopefully) easy to use API.</p>
<hr />
<div class="footnote-definition" id="2"><sup class="footnote-definition-label">1</sup>
<p><a href="https://blog.mozilla.org/security/2018/01/03/mitigations-landing-new-class-timing-attack/%5D">https://blog.mozilla.org/security/2018/01/03/mitigations-landing-new-class-timing-attack/</a></p>
</div>
<div class="footnote-definition" id="3"><sup class="footnote-definition-label">2</sup>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/SharedArrayBuffer">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/SharedArrayBuffer</a></p>
</div>
<div class="footnote-definition" id="4"><sup class="footnote-definition-label">3</sup>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Atomics">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Atomics</a></p>
</div>
<div class="footnote-definition" id="5"><sup class="footnote-definition-label">4</sup>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/SharedArrayBuffer#security_requirements">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/SharedArrayBuffer#security_requirements</a></p>
</div>
<div class="footnote-definition" id="6"><sup class="footnote-definition-label">5</sup>
<p><a href="https://github.com/wngr/wasm-hello-world/tree/master/main-context">https://github.com/wngr/wasm-hello-world/tree/master/main-context</a></p>
</div>
<div class="footnote-definition" id="7"><sup class="footnote-definition-label">6</sup>
<p><a href="https://github.com/wngr/wasm-hello-world/tree/master/single-web-worker">https://github.com/wngr/wasm-hello-world/tree/master/single-web-worker</a></p>
</div>
<div class="footnote-definition" id="8"><sup class="footnote-definition-label">7</sup>
<p><a href="https://github.com/wngr/wasm-hello-world/tree/master/multi-web-worker">https://github.com/wngr/wasm-hello-world/tree/master/multi-web-worker</a></p>
</div>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../about.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../blog/2021-04-06_Sniffing-into-Signal-Backups.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../about.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../blog/2021-04-06_Sniffing-into-Signal-Backups.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
